• 多渠道对账工具设计文档

  - 项目背景与目标
      - 基于现有 wacai.py 导出能力，新增一个支持微信支付 XLSX、支付宝 CSV、中信信用卡 XLSX、招商
        信用卡 EML 的账单整合与对账工具。
      - 自动将多渠道流水清洗、分类、去重后写入与 wacai.xlsx 相同结构的新 Excel，直接可导入挖财或继
        续使用现有流程。
      - 在导入前对照现有 wacai.xlsx，金额重复的记录不再写入；保留来源渠道信息供后续追溯。
  - 范围定义
      - 涵盖支出、收入、转账、借入借出、收款还款五个工作表。
      - 分类依据现有模板列，优先使用大模型对交易备注进行自动归类，无映射时标记“待分类”并在备注中
        提示。
      - 每次运行输出 data/wacai-YYYYMMDDHHMM.xlsx 时间戳文件，包含旧数据 + 新增非重复条目；备注或新增列写入来源渠道，避免覆盖原有记录。
      - 数据源目录：data/，包含四类渠道示例及 wacai-demo.xls、wacai.xlsx 参考模板，其中 wacai.xlsx 为对账基线。
  - 模板字段与中间 Schema
      - wacai.xlsx 各工作表列结构分别为：支出 12 列、收入 10 列、转账 9 列、借入借出 7 列、收款还款 8 列，列名需保持与模板一致。
      - 标准化后的中间结果亦采用 5 张表结构，生成 CSV（建议位置：`intermediate/{channel}/{sheet}.csv`），确保列顺序与模板一致，编码使用 UTF-8-SIG。
      - 若某渠道无对应数据，也要输出仅含表头的空 CSV，保持后续对账流程的统一输入。
  - 用户场景
      - 用户下载各渠道账单放入 data/，执行命令生成带时间戳的新文件（如 wacai-202510121151.xlsx）。
      - 用户可只提供部分渠道文件，工具自动跳过缺失文件。
      - 用户可选择是否启用大模型分类，或提供手工映射表覆盖模型输出。
  - 流程与系统架构
      1. 数据标准化：扫描 data/，识别可用账单文件（按命名模式或扩展名），调用各渠道解析器。
          - 每个解析器输出 5 份 DataFrame，对应支出/收入/转账/借入借出/收款还款，列名、顺序与 wacai.xlsx 模板一致，金额采用 Decimal，日期统一为 timezone-aware datetime。
          - 中间结果写入 CSV（例如 `intermediate/wechat/支出.csv` 等）供调试或作为后续对账输入；所有 CSV 均保持 UTF-8 编码。
          - 招商信用卡复用 cmb_parser.py；新增微信、支付宝、中信解析器遵循相同接口。
      2. 自动对账：读取现有 data/wacai.xlsx（或指定基线文件），建立去重索引（金额 + 日期容差 + 渠道或原始 ID）。
          - 比对新旧数据，标记新增、疑似重复、已存在的条目；输出统计与日志。
          - 支持 `--dry-run` 仅生成报告，不写回 Excel。
          - 若发现基线账本中存在“备注=余额调整产生的烂账”或“收入大类=漏记款”记录，则将该条交易时间作为该账户的锁定时间，锁定时间之前的同账户交易视为已核对，不再导入。
          - 针对退款场景：在同一账期内若发现一笔支出与一笔对等金额（金额取绝对值相等、方向相反）且备注一致的记录（含来源渠道），判定为原交易已退款，两条记录均不再导入，并在报告中记录对应信息。
      3. 交互导入：通过命令行逐条或按批次确认新增记录。
          - 提供“全部导入”“跳过本条”“标记待确认”等选项，可用 `--auto-confirm` 开启无交互模式。
          - 用户确认后写入模板工作表，并记录导入报告（如 reports/import_YYYYMMDD.csv）。
  - 功能需求明细
      - 支持命令行入口：uv run python reconcile.py --input-dir data --output-prefix data/wacai.
      - 允许传入 --llm 配置（模型名称、API Key、批次大小），或 --no-llm 仅依赖规则。
      - 日志输出导入条目数、跳过条目数（按金额去重）、分类成功率、未匹配分类条目列表。
      - 提供配置文件（如 config/categories.yml）维护固定映射：交易号/关键词→模板分类。
      - 生成后的 Excel 排序按交易时间倒序；保留原币种、汇率信息在备注。
      - 命令行交互模块基于 argparse + 简单输入提示，后续可集成 prompt-toolkit。
      - 支持 `--report-path` 自定义导入报告输出目录。
      - 输出文件命名规则：根据执行时间生成 `"{output-prefix}-{YYYYMMDDHHMM}.xlsx"`，保留历史版本，不覆盖既有文件。
      - 支持 `--account-lock` 相关设置，控制遇到余额调整或漏记款时的锁定行为（默认启用）。
      - 支持退款匹配配置（如 `--refund-window 30d`），控制金额相反且备注一致的支出/退款自动抵消逻辑，默认开启并输出匹配日志。
  - 非功能要求
      - 解析与分类模块解耦，便于未来新增渠道。
      - 处理 10 万级别交易记录的性能需在 5 分钟内完成。
      - 对异常文件（空文件、格式错误）给出明确错误提示，不影响其他渠道处理。
      - 遵循当前仓库编码规范（PEP 8，四空格缩进，UTF-8）。
  - 开放问题与假设
      - 金额一致即认定重复，可能误删不同日期的同额交易；需在文档中提示用户风险。
      - 大模型调用依赖外部网络及权限，默认提供接口占位与本地缓存机制，需用户自配 API Key。
      - 若未来需要更精细的重复判定（时间/交易号），将作为后续迭代。
      - 余额调整/漏记款锁定策略依赖备注及大类文本匹配，若模板字段变化需同步更新规则。
      - 退款抵消依赖金额与备注精确匹配，若上游渠道备注存在差异需提供自定义映射或人工确认。
  - 实施阶段建议
      1. M1：基础解析与输出
          - 实现四渠道解析器，将各渠道账单标准化为 5 张 CSV（支出/收入/转账/借入借出/收款还款）并写入中间目录；补齐 data/ 下最小化示例。
          - 定义判重规则（金额 + 日期差阈值 + 渠道/原始 ID）并支持 dry-run。
      2. M2：去重与分类增强
          - 完成金额去重逻辑、分类失败提示、来源渠道写入；输出对账日志和导入报告。
          - 引入可调判重策略（金额相同但日期差大时提示复核），实现支出与退款抵消规则及锁定日志。
      3. M3：大模型接入
          - 集成 LLM 分类接口、缓存策略、失败回退。
      4. M4：体验优化
          - 增加命令行参数、生成导入报告、引导用户配置映射表。
  - 风险与缓解
      - 分类准确率不稳定：引入可编辑映射表 + 人工二次确认列表。
      - 金额重复误判：日志列出被剔除交易（含日期、渠道），允许用户手工恢复。
      - 外部模型依赖：提供纯规则模式，避免网络受限导致分类失败。
      - 模板字段变化：建立单元测试对照 wacai-demo.xls，确保生成结构一致。

  该设计文档可作为后续开发、评审和排期的基础。若有新增需求或调整，请继续补充，我会同步更新。

  codex resume 0199d365-b2e0-77a1-a4ab-fbf3da3854cd
